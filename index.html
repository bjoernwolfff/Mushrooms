<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pilzerkennung (MobileNet, TFJS)</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

</head>
<body>
  <div id="container">
    <h1>Pilzerkennung</h1>
    <input type="file" id="imageUpload" accept="image/*" />
    <img id="preview" src="" alt="Bildvorschau" style="display:none;" />
    <button id="predictBtn" disabled>Erkennen</button>
    <div id="result"></div>
    <div id="magicChance"></div>
  </div>

<script>
  let model;
  const imageUpload = document.getElementById('imageUpload');
  const preview = document.getElementById('preview');
  const predictBtn = document.getElementById('predictBtn');
  const result = document.getElementById('result');
  const magicChance = document.getElementById('magicChance');

  async function loadModel() {
    result.textContent = 'Modell wird geladen...';
    model = await mobilenet.load();
    result.textContent = 'Modell geladen. Bitte Bild hochladen.';
    predictBtn.disabled = false;
  }

  imageUpload.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      preview.src = reader.result;
      preview.style.display = 'block';
      result.textContent = '';
      magicChance.textContent = '';
    };
    reader.readAsDataURL(file);
  });

  predictBtn.addEventListener('click', async () => {
    if (!model) return;
    result.textContent = 'Erkenne...';
    magicChance.textContent = '';
    const predictions = await model.classify(preview);

    if (predictions.length > 0) {
      // Top 3 Ergebnisse anzeigen
      result.innerHTML = predictions.slice(0, 3).map(p => 
        `${p.className} — ${(p.probability * 100).toFixed(1)}%`
      ).join('<br>');

      // Suche nach "magic mushroom"-ähnlichen Begriffen
      const keywords = ['magic mushroom', 'psilocybe', 'fliegenpilz', 'mushroom'];
      let maxMagicProb = 0;

      predictions.forEach(p => {
        const label = p.className.toLowerCase();
        if (keywords.some(k => label.includes(k))) {
          if (p.probability > maxMagicProb) maxMagicProb = p.probability;
        }
      });

      if (maxMagicProb > 0) {
        magicChance.textContent = `Wahrscheinlichkeit für Magic Mushroom: ${(maxMagicProb * 100).toFixed(1)}%`;
      } else {
        magicChance.textContent = `Magic Mushroom nicht erkannt.`;
      }

    } else {
      result.textContent = 'Keine Vorhersagen möglich.';
    }
  });

  loadModel();
</script>
</body>
</html>



