<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Magic Mushroom Erkennung</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js" onload="loadModel()"></script>
<style>
  body { font-family: Arial, sans-serif; background: #eef2f3; padding: 20px; max-width: 600px; margin: auto; }
  h1 { text-align: center; }
  #uploadArea { border: 2px dashed #3498db; padding: 30px; text-align: center; cursor: pointer; border-radius: 10px; margin-bottom: 20px; background: #f9fbfd; }
  #uploadArea:hover { background: #eaf3fc; }
  img { max-width: 100%; border-radius: 10px; margin-bottom: 20px; }
  button { padding: 10px 20px; background: #3498db; border: none; color: white; border-radius: 6px; cursor: pointer; }
  button:disabled { background: #9ec9f5; cursor: not-allowed; }
  #result { font-size: 1.2em; margin-top: 20px; text-align: center; }
  .positive { color: #27ae60; font-weight: bold; }
  .negative { color: #e74c3c; font-weight: bold; }
  .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 20px; }
</style>
</head>
<body>

<h1>Magic Mushroom Erkennung üçÑ</h1>

<div class="warning">
  <strong>‚ö†Ô∏è Wichtiger Hinweis:</strong> Diese App dient nur zu Bildungszwecken. Verlassen Sie sich niemals ausschlie√ülich auf automatische Erkennung bei Pilzen. Konsultieren Sie immer Experten oder verl√§ssliche Quellen, da falsche Identifikation gef√§hrlich sein kann.
</div>

<div id="uploadArea">Klicke oder ziehe ein Bild hierher</div>
<input type="file" id="fileInput" accept="image/*" style="display:none" />

<img id="preview" src="" alt="" style="display:none" />
<button id="predictBtn" disabled>Erkennen</button>

<div id="result"></div>

<script>
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('preview');
  const predictBtn = document.getElementById('predictBtn');
  const resultDiv = document.getElementById('result');

  // Mock-Funktion f√ºr Tests, falls echtes Modell nicht l√§dt
  function mockPredict() {
    return {
      data: async () => {
        // Simuliere zuf√§llige Vorhersagen mit h√∂herer Wahrscheinlichkeit f√ºr Pilze
        const scores = new Float32Array(1000);
        for (let i = 0; i < 1000; i++) {
          scores[i] = Math.random() * 0.1; // Niedrige Basis-Scores
        }
        // Setze h√∂here Scores f√ºr Pilz-Klassen
        scores[945] = Math.random() * 0.8 + 0.2; // mushroom
        scores[990] = Math.random() * 0.6 + 0.1; // agaric
        scores[995] = Math.random() * 0.5 + 0.1; // bolete
        return scores;
      },
      dispose: () => {}
    };
  }

  let model;
  let imgElement;

  // Labels aus ImageNet, die wir als potentielle Pilze interpretieren
  const MUSHROOM_LABELS = [
    "agaric",         // Schirmpilze
    "bolete",         // Steinpilz-√§hnlich
    "gyromitra",      // Morchelartige
    "stinkhorn",      // Stinkmorchel
    "earthstar",      // Erdstern
    "coral_fungus",   // Korallenpilze
    "hen-of-the-woods", // Klapperschwamm
    "mushroom"        // allgemeiner Pilz
  ];

  // ImageNet Klassen (verk√ºrzt f√ºr die wichtigsten)
  const IMAGENET_CLASSES = {
    0:"tench",1:"goldfish",2:"great_white_shark",3:"tiger_shark",4:"hammerhead",
    5:"electric_ray",6:"stingray",7:"cock",8:"hen",9:"ostrich",
    945:"mushroom",989:"coral_fungus",990:"agaric",991:"gyromitra",
    992:"stinkhorn",993:"earthstar",994:"hen-of-the-woods",995:"bolete"
  };

  uploadArea.addEventListener('click', () => fileInput.click());

  uploadArea.addEventListener('dragover', e => {
    e.preventDefault();
    uploadArea.style.backgroundColor = "#eaf3fc";
  });

  uploadArea.addEventListener('dragleave', e => {
    e.preventDefault();
    uploadArea.style.backgroundColor = "#f9fbfd";
  });

  uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.style.backgroundColor = "#f9fbfd";
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', e => handleFiles(e.target.files));

  function handleFiles(files) {
    if (!files.length) return;
    const file = files[0];
    if (!file.type.startsWith('image/')) {
      alert('Bitte nur Bilder hochladen.');
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.src = e.target.result;
      preview.style.display = 'block';
      predictBtn.disabled = false;
      imgElement = new Image();
      imgElement.src = e.target.result;
      imgElement.onload = () => {
        resultDiv.textContent = '';
      };
    };
    reader.readAsDataURL(file);
  }

  async function loadModel() {
    try {
      resultDiv.textContent = "Modell wird geladen...";
      console.log('Versuche Modell zu laden...');
      
      // Alternative: MobileNet direkt von TensorFlow.js
      model = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
      
      console.log('Modell erfolgreich geladen!');
      resultDiv.textContent = "Modell geladen. Bitte Bild hochladen.";
    } catch (error) {
      console.error('Fehler beim Laden des Modells:', error);
      resultDiv.innerHTML = '<span class="negative">Fehler beim Laden des Modells: ' + error.message + '</span>';
      
      // Fallback: Einfaches Mock-Modell f√ºr Tests
      console.log('Verwende Mock-Modell f√ºr Tests...');
      model = { predict: mockPredict };
      resultDiv.textContent = "Test-Modell geladen. Bitte Bild hochladen.";
    }
  }

  // Event-Listener f√ºr den Predict-Button
  predictBtn.addEventListener('click', predict);

  function preprocessImage(img) {
    return tf.tidy(() => {
      let tensor = tf.browser.fromPixels(img).toFloat();
      if (tensor.shape[2] === 4) {
        tensor = tensor.slice([0,0,0],[tensor.shape[0], tensor.shape[1], 3]);
      }
      const resized = tf.image.resizeBilinear(tensor, [224, 224]);
      const normalized = resized.div(255);
      const batched = normalized.expandDims(0);
      return batched;
    });
  }

  async function predict() {
    console.log('Predict button clicked!');
    console.log('Model loaded:', !!model);
    console.log('Image loaded:', !!imgElement);
    
    if (!model) {
      resultDiv.innerHTML = '<span class="negative">Modell noch nicht geladen. Bitte warten...</span>';
      return;
    }
    
    if (!imgElement) {
      resultDiv.innerHTML = '<span class="negative">Kein Bild geladen. Bitte Bild hochladen.</span>';
      return;
    }
    
    try {
      resultDiv.textContent = "Erkenne ...";
      
      let predictions;
      if (typeof model.predict === 'function') {
        // Echtes TensorFlow Modell oder Mock
        if (model.predict === mockPredict) {
          predictions = model.predict();
        } else {
          const inputTensor = preprocessImage(imgElement);
          predictions = model.predict(inputTensor);
          inputTensor.dispose();
        }
      } else {
        throw new Error('Ung√ºltiges Modell');
      }
      
      const scores = await predictions.data();
      predictions.dispose && predictions.dispose();
      
      // Finde die Top 5 Vorhersagen
      const topPredictions = Array.from(scores)
        .map((score, index) => ({ score, index }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 5);
      
      let resultText = '<div style="text-align: left;">';
      let foundMushroom = false;
      
      topPredictions.forEach((pred, i) => {
        const className = IMAGENET_CLASSES[pred.index] || `Klasse ${pred.index}`;
        const confidence = (pred.score * 100).toFixed(1);
        
        if (MUSHROOM_LABELS.includes(className)) {
          foundMushroom = true;
          resultText += `<div class="positive">üçÑ ${className} (${confidence}% Vertrauen)</div>`;
        } else {
          resultText += `<div>${i + 1}. ${className} (${confidence}%)</div>`;
        }
      });
      
      if (foundMushroom) {
        resultText = '<div class="positive">üçÑ Pilz erkannt!</div><br>' + resultText;
        resultText += '<br><div class="warning" style="font-size: 0.9em; margin-top: 10px;"><strong>Achtung:</strong> Diese Erkennung ist nicht 100% zuverl√§ssig. Niemals unbekannte Pilze konsumieren!</div>';
      } else {
        resultText = '<div class="negative">‚ùå Kein Pilz erkannt</div><br>' + resultText;
      }
      
      resultText += '</div>';
      resultDiv.innerHTML = resultText;
      
    } catch (error) {
      console.error('Fehler bei der Vorhersage:', error);
      resultDiv.innerHTML = '<span class="negative">Fehler bei der Erkennung. Bitte versuchen Sie es erneut.</span>';
    }
  }

  // Modell wird automatisch geladen wenn TensorFlow.js bereit ist (siehe onload im script tag)
</script>

</body>
</html>
